
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Rails3,GridFS,MongoID,CarrierWave实现图片上传 &larr; Ruby|Rails|Vim|Mac|Linux</title>
   <meta name="author" content="Tim.Tang,Linux,ROR,Mac,Vim,Git" />
   <meta name="google-site-verification" content="7JJnZst8sKxU-b4eWEkwnN6hvo9ekME6QcDiqB9aRdo" />
   <meta name="baidu-site-verification" content="f85E439uCSJKI89f" />
   <meta name="description" content="Rails3,GridFS,MongoID,CarrierWave实现图片上传">
   <link href="favicon.ico" rel="icon" type="image/x-icon">
   <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
   <link rel="start" href="/" />

	
	<meta name="keywords" content="rails3 gridfs mongoid carrierwave photo upload">
	

	
  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/feedname" title="RSS feed" />
	
  	<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="RSS feed" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/screen.css" type="text/css" />

   <!-- JavaScript -->
    <script type="text/javascript" src="/assets/themes/mark-reid/js/jquery-1.7.min.js" ></script>
    <script type="text/javascript" src="/assets/themes/mark-reid/js/mustache.js" ></script>
    <script type="text/javascript" src="/assets/themes/mark-reid/js/search.js" ></script>
    <script type="text/javascript" src="/assets/themes/mark-reid/js/app.js" ></script>

</head>
<body id="">
<div id="site">

  <div id="header">
    <h1>
    	<a href="/" title="Tech Talkin~">Tech Talkin~</a>
    	<span class="byline">&larr; <a href="/">Tim.Tang</span>
    </h1>
    <ul class="nav">
      <li><a class="home" href="/">Home</a></li>
      <li><a  href="/archive.html">Archive</a></li>
      <li><a  href="/categories.html">Categories</a></li>
      <li><a  href="/tags.html">Tags</a></li>
      <li><a  href="/about.html">About</a></li>
    </ul>
  </div>

  
<div id="page">
<!--
  <ul class="tag_box inline">
  
  


  
     
    	<li><a href="/tags.html#Rails-ref">Rails <span>17</span></a></li>
     
    	<li><a href="/tags.html#MongoDB-ref">MongoDB <span>7</span></a></li>
    
  



  </ul>
 -->

  <h1 class="emphnext">Rails3,GridFS,MongoID,CarrierWave实现图片上传</h1>

  <p>最近准备将Everyday CMS的数据存储由MySQL切换到MongoDB,作为实验先探探路，看看能不能用MongoDB的GridFS来存储图片，下面具体的实现：</p>

<h2 id='rails_313ruby_192p320mongodb_'>首先环境准备：Rails 3.1.3/Ruby 1.9.2p320/MongoDB 已经安装并启动.</h2>

<h2 id='app'>创建app</h2>

<pre><code>$ rails new demo</code></pre>

<h2 id='gemfilegems'>修改Gemfile文件，加入如下Gems</h2>

<pre><code>gem &#39;mongoid&#39; #2.4.10
gem &#39;bson_ext&#39; #1.6.2
gem &#39;carrierwave&#39; #0.5.8
gem &#39;carrierwave-mongoid&#39;, :require =&gt; &#39;carrierwave/mongoid&#39; #0.1.7
gem &#39;mini_magick&#39; #3.4</code></pre>

<h2 id='mongoidyml'>生成mongoid.yml</h2>

<pre><code>$ rails g mongoid:config</code></pre>

<h2 id='_configapplicationrb'>通过修改 config/application.rb去掉对默认数据库依赖</h2>

<pre><code>require &#39;rails/all&#39;
require &quot;action_controller/railtie&quot;
require &quot;action_mailer/railtie&quot;
require &quot;active_resource/railtie&quot;
require &quot;rails/test_unit/railtie&quot;</code></pre>

<h2 id='_error_mongoid_not_found_'>继续添加以下代码，防止 error mongoid not found 的问题</h2>

<pre><code>config.generators do |g|
  g.orm :active_record
end</code></pre>

<h2 id='_configdatabaseymlscaffoldblog'>删除默认的 config/database.yml，并用scaffold创建blog应用:</h2>

<pre><code>$ rm -f config/database.yml
$ rails g scaffold blog name:string content:text</code></pre>

<h2 id='carrierwave_configinitializerscarrierwaverb'>添加carrierwave配置文件 config/initializers/carrierwave.rb</h2>

<pre><code>CarrierWave.configure do |config|
  config.storage = :grid_fs
  config.grid_fs_access_url = &quot;&quot;
  config.grid_fs_database = Mongoid.database.name
  config.grid_fs_host = Mongoid.config.master.connection.host
end</code></pre>

<h2 id='file_uploader'>生成File Uploader</h2>

<pre><code>$ rails g uploader File</code></pre>

<h2 id='appuploadersfile_uploaderrb'>修改app/uploaders/file_uploader.rb</h2>

<pre><code>class FileUploader &lt; CarrierWave::Uploader::Base
  include CarrierWave::MiniMagick
  # Choose what kind of storage to use for this uploader:
  storage :grid_fs
  # Override the directory where uploaded files will be stored.
  def store_dir
	&quot;uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}&quot;
  end
  def default_url
	 &quot;/uploads/fallback/&quot; + [version_name, &quot;default.png&quot;].compact.join(&#39;_&#39;)
  end
  # Create different versions of your uploaded files:
  version :thumb do
	 process :resize_to_fill=&gt; [50, 50]
  end
  version :normal do
	 process :resize_to_fill =&gt; [150, 200]
  end
  version :big do
	 process :resize_to_fill =&gt; [250, 300]
  end
  version :large do
	 process :resize_to_fill =&gt; [350, 400]
  end
  def extension_white_list
	 %w(jpg jpeg gif png)
  end
  def filename
	 &quot;something.jpg&quot; if original_filename
  end
end</code></pre>

<h2 id='gridfscontroller'>生成生成gridfs的controller</h2>

<pre><code>$ rails g controller gridfs</code></pre>

<h2 id='gridfscontroller'>修改GridfsController,内容如下</h2>

<pre><code>class GridfsController &lt; ActionController::Metal
  def serve
	gridfs_path = env[&quot;PATH_INFO&quot;].gsub(&quot;/uploads/&quot;, &quot;uploads/&quot;)
	begin
	  puts &quot;---------------------------------------&quot;
	  puts gridfs_path
	  puts Mongoid.database.name
	  puts &quot;---------------------------------------&quot;
	  gridfs_file = Mongo::GridFileSystem.new(Mongoid.database).open(gridfs_path, &#39;r&#39;)
	  self.response_body = gridfs_file.read
	  self.content_type = gridfs_file.content_type
	rescue Exception =&gt; e
	  self.status = :file_not_found
	  Rails.logger.debug { &quot;#{e}&quot; }
	  self.content_type = &#39;text/plain&#39;
	  self.response_body = &#39;&#39;
	  raise e
	end
  end
end</code></pre>

<h2 id='routesrbgridfscontroller'>修改routes.rb，使开发模式下，通过gridfs这个controller来管理图片文件</h2>

<pre><code>if Rails.env.development?
  match &quot;/uploads/*path&quot; =&gt; &quot;gridfs#serve&quot;
end</code></pre>

<h2 id='appmodelsblogrbfileuploader_active_record'>修改app/models/blog.rb，添加file字段，并挂载uploader, 注意这里不再继承active record.</h2>

<pre><code>class Blog
 include Mongoid::Document
   field :name
   field :content
   field :file
   mount_uploader :file, FileUploader
end</code></pre>

<h2 id='appviewsblogs_formhtmlerbcontent'>修改app/views/blogs/_form.html.erb，在content表单项下面添加图片上传</h2>

<pre><code>&lt;%= f.label :file %&gt;
&lt;%= f.file_field :file %&gt;</code></pre>

<h2 id='_appviewsblogsindexhtmlerb_'>修改 app/views/blogs/index.html.erb, 用来展现上传的图片</h2>

<pre><code>&lt;%= blog.file.size %&gt;
&lt;%= blog.file.filename%&gt;
&lt;%= image_tag blog.file_url(:thumb)%&gt;
&lt;%= image_tag blog.file_url(:normal)%&gt;
&lt;%= image_tag blog.file_url(:big)%&gt;
&lt;%= image_tag blog.file_url(:large)%&gt;</code></pre>

<h2 id='id163'>到这里终于可以启动服务，上传图片了，看看结果</h2>

<p><img alt='carrierwave-mogoid' src='/images/post/carrierwave-mongoid.png' width='600' /></p>

<h2 id='mongodbcollection'>再看mongodb的查询结果，多了三个collection以及对于的储存记录</h2>

<p><img alt='mogo-result' src='/images/post/mongodb-result.png' width='600' /></p>

<blockquote>
<p>注意:尽量不要在rails3.1以下版本操作，否则会出现无法集成mongoid的问题，OK JSUT DO IT!</p>
</blockquote>

  <address class="signature">
   <!--
    <a class="author" href="/">Tim.Tang,Linux,ROR,Mac,Vim,Git</a>
	-->
	<span class="author">334 Words</span>
    <span class="date">24 May 2012</span>
    <span class="location">Suzhou, China</span>
  </address>

  <div class="prev-next">
  
    <a href="/blog/2012/05/25/rakemysqlmongo-gridfs" class="next" title="Rake从MySQL向Mongo GridFS迁移图片数据">Next Post &rarr;</a>
  
  
    <a href="/blog/2012/05/22/xmljsonmongodb" class="prev" title="XML,JSON转换存MongoDB">&larr; Earlier Post</a>
  
  </div>

</div><!-- End Page -->




  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'timstechtalk'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>







  <a class="go_top" href="#"><i class="icon icons_go_top"></i></a>
  <div id="footer">
  	<address>
  		<span class="copyright">
  			Content by <a href="/info/site.html">Tim.Tang,Linux,ROR,Mac,Vim,Git</a>
  			<br/>
  		</span>
  		<span class="engine">
			Powered by <a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
            <a href="http://www.prchecker.info/" title="PageRank Checking Icon" target="_blank">
                <img src="http://pr.prchecker.info/getpr.php?codex=aHR0cDovL3RpbS5ldmVyeWRheS1jbi5jb20=&tag=3" alt="PageRank Checking Icon" align="absmiddle" style="margin-left:8px;border:0;"/>
            </a>
  		</span>
  	</address>
  </div>

</div>

<!--[if IE 6]>
<script type="text/javascript">
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; }
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->

  
</body>
</html>

